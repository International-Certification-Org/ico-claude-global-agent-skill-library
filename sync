#!/usr/bin/env bash
#
# ICO Global Claude Agents & Skills installation script
#
# This script copies the contents of the `agents/`, `skills/`, `runbooks/` and
# `templates/` directories into the user's global Claude configuration
# directory. The script may be invoked via `curl -fsSL <repo>/sync | bash`.

set -euo pipefail

REPO_TARBALL="https://github.com/International-Certification-Org/ico-claude-global-agent-skill-library/archive/main.tar.gz"

# Determine the target directory for Claude configuration
if [ -d "$HOME/.config/claude" ]; then
  TARGET_DIR="$HOME/.config/claude"
else
  TARGET_DIR="$HOME/.claude"
fi

# Ensure target subdirectories exist
mkdir -p "$TARGET_DIR"/{agents,skills,runbooks,templates}

# Download and extract repo tarball
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

echo "Downloading ICO Claude Global Agents & Skills Library..."
curl -fsSL "$REPO_TARBALL" | tar -xz -C "$TMP_DIR"
EXTRACTED_DIR="$TMP_DIR/ico-claude-global-agent-skill-library-main"

# Compare and show changes
echo ""
NEW_FILES=()
MODIFIED_FILES=()
LOCAL_ONLY=()
UNCHANGED=0

for dir in agents skills runbooks templates; do
  # Check for new/modified from repo
  if [ -d "$EXTRACTED_DIR/$dir" ]; then
    for file in "$EXTRACTED_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")
      target_file="$TARGET_DIR/$dir/$filename"

      if [ ! -f "$target_file" ]; then
        NEW_FILES+=("$dir/$filename")
      elif ! diff -q "$file" "$target_file" > /dev/null 2>&1; then
        MODIFIED_FILES+=("$dir/$filename")
      else
        ((UNCHANGED++)) || true
      fi
    done
  fi

  # Check for local-only files (exist locally but not in repo)
  if [ -d "$TARGET_DIR/$dir" ]; then
    for file in "$TARGET_DIR/$dir"/*; do
      [ -f "$file" ] || continue
      filename=$(basename "$file")

      # Skip .zip files (artifacts)
      [[ "$filename" == *.zip ]] && continue

      repo_file="$EXTRACTED_DIR/$dir/$filename"

      if [ ! -f "$repo_file" ]; then
        LOCAL_ONLY+=("$dir/$filename")
      fi
    done
  fi
done

# Show results
if [ ${#NEW_FILES[@]} -gt 0 ]; then
  echo "New files:"
  for f in "${NEW_FILES[@]}"; do echo "   + $f"; done
fi

if [ ${#MODIFIED_FILES[@]} -gt 0 ]; then
  echo "Modified:"
  for f in "${MODIFIED_FILES[@]}"; do echo "   ~ $f"; done
fi

if [ ${#LOCAL_ONLY[@]} -gt 0 ]; then
  echo "Local only (not in repo):"
  for f in "${LOCAL_ONLY[@]}"; do echo "   ? $f"; done
fi

if [ ${#NEW_FILES[@]} -eq 0 ] && [ ${#MODIFIED_FILES[@]} -eq 0 ]; then
  echo "Already up to date ($UNCHANGED files)"
else
  # Actually copy the files
  echo ""
  echo "Installing into $TARGET_DIR..."
  cp -r "$EXTRACTED_DIR/agents/." "$TARGET_DIR/agents/"
  cp -r "$EXTRACTED_DIR/skills/." "$TARGET_DIR/skills/"
  cp -r "$EXTRACTED_DIR/runbooks/." "$TARGET_DIR/runbooks/"
  cp -r "$EXTRACTED_DIR/templates/." "$TARGET_DIR/templates/"
  echo "Updated: ${#NEW_FILES[@]} new, ${#MODIFIED_FILES[@]} modified, $UNCHANGED unchanged"
fi

# Cleanup: remove .zip artifacts from skills directory
ZIP_COUNT=$(find "$TARGET_DIR/skills" -name "*.zip" 2>/dev/null | wc -l)
if [ "$ZIP_COUNT" -gt 0 ]; then
  rm -f "$TARGET_DIR/skills"/*.zip
  echo "Cleaned up $ZIP_COUNT .zip artifact(s)"
fi
